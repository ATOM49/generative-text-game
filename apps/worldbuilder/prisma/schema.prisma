// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/**
 * ---------- Enums ----------
 */
enum EntityType {
  CHARACTER
  FACTION
  NPC
  ITEM
  QUEST
}

enum RelationshipType {
  ally
  enemy
  memberOf
  questGiver
  owns
  guards
}

enum TreasureHuntRunStatus {
  ACTIVE
  SUCCESS
  FAILED
}

enum TreasureHuntEventType {
  MOVE
  EXPLORE
}

enum FactionCategory {
  faction
  culture
  species
  entity
  archetype
}

enum UserRole {
  BUILDER
  EXPLORER
}

/**
 * ---------- Authentication ----------
 */
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(EXPLORER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  authenticators Authenticator[]
}

model Account {
  id                       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                   String   @db.ObjectId
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?  @map("refresh_token")
  refresh_token_expires_in Int?     @map("refresh_token_expires_in")
  access_token             String?  @map("access_token")
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?  @map("id_token")
  session_state            String?  @map("session_state")

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Authenticator {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  credentialID        String   @unique
  userId              String   @db.ObjectId
  providerAccountId   String
  credentialPublicKey String
  counter             Int
  credentialDeviceType String
  credentialBackedUp  Boolean
  transports          String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

/**
 * ---------- Worlds ----------
 */
model World {
  id                      String                   @id @default(auto()) @map("_id") @db.ObjectId
  name                    String
  description             String?
  theme                   String?
  contextWindowLimit      Int?
  version                 Int                      @default(1)
  mapImageUrl             String?
  settings                Json?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  worldGrid               WorldGrid?
  treasureHuntConfig      TreasureHuntConfig?
  playerWorldExplorations PlayerWorldExploration[]
  treasureHuntRuns        TreasureHuntRun[]

  @@index([name])
}

/**
 * ---------- Locations (point in rel coords) ----------
 */
model Location {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  worldId     String  @db.ObjectId
  name        String
  description String?
  gridCellId  String? @db.ObjectId
  coordRel    Json // { u, v } in [0,1]
  props       Json?

  @@index([worldId])
  @@index([worldId, gridCellId])
  @@index([name])
}

/**
 * ---------- Entities ----------
 */
model Entity {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  worldId    String     @db.ObjectId
  type       EntityType
  name       String
  locationId String?    @db.ObjectId
  gridCellId String?    @db.ObjectId
  coordRel   Json? // fallback if no locationId
  attributes Json?
  tags       String[]

  @@index([worldId, type])
  @@index([worldId, locationId])
  @@index([worldId, gridCellId])
  @@index([name])
}

model Faction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  worldId     String          @db.ObjectId
  name        String
  summary     String?
  description String?
  previewUrl  String?
  category    FactionCategory
  meta        Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([worldId, category])
  @@index([worldId, name])
}

model Character {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  worldId      String   @db.ObjectId
  name         String
  description  String?
  biography    String?
  previewUrl   String?
  promptHint   String?
  traits       String[] @default([])
  factionIds   String[] @default([]) @db.ObjectId
  cultureIds   String[] @default([]) @db.ObjectId
  speciesIds   String[] @default([]) @db.ObjectId
  archetypeIds String[] @default([]) @db.ObjectId
  meta         Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([worldId])
  @@index([worldId, name])
}

/**
 * ---------- Relationships ----------
 */
model Relationship {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  worldId      String           @db.ObjectId
  fromEntityId String           @db.ObjectId
  toEntityId   String           @db.ObjectId
  type         RelationshipType
  weight       Float?
  constraints  Json?
  validity     Json?
  props        Json?

  @@index([worldId, fromEntityId, type])
  @@index([worldId, toEntityId, type])
  @@index([worldId, type])
}

/**
 * ---------- Player ----------
 */
model Player {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  explorations PlayerWorldExploration[]
  runs         TreasureHuntRun[]
  events       TreasureHuntEvent[]

  @@index([name])
}

// --- grid / cells ---

model WorldGrid {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  worldId    String @unique @db.ObjectId
  world      World  @relation(fields: [worldId], references: [id])
  width      Int
  height     Int
  homeCellId String // references GridCell.id by convention (no hard FK)

  cells GridCell[]
  hunts TreasureHuntRun[]
}

model GridCell {
  id     String    @id @default(auto()) @map("_id") @db.ObjectId
  gridId String    @db.ObjectId
  grid   WorldGrid @relation(fields: [gridId], references: [id])

  x        Int
  y        Int
  walkable Boolean
  biome    String?
  name        String?
  description String?
  tags        String[] @default([])

  @@index([gridId, x, y], name: "grid_xy_unique_idx")
}

// --- config per world ---

model TreasureHuntConfig {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  worldId String @unique @db.ObjectId
  world   World  @relation(fields: [worldId], references: [id])

  maxActionsPerRun           Int
  minKeyDistance             Int
  maxKeyDistance             Int
  minTreasureDistanceFromKey Int
  maxTreasureDistanceFromKey Int
}

// --- player exploration memory ---

model PlayerWorldExploration {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  playerId String @db.ObjectId
  worldId  String @db.ObjectId
  player   Player @relation(fields: [playerId], references: [id])
  world    World  @relation(fields: [worldId], references: [id])

  exploredCellIds Json // array of CellId strings
  totalRuns       Int  @default(0)
  bestRunActions  Int?

  @@unique([playerId, worldId])
}

// --- run state ---

model TreasureHuntRun {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  worldId  String @db.ObjectId
  gridId   String @db.ObjectId
  playerId String @db.ObjectId

  world  World     @relation(fields: [worldId], references: [id])
  grid   WorldGrid @relation(fields: [gridId], references: [id])
  player Player    @relation(fields: [playerId], references: [id])

  runIndex  Int
  status    TreasureHuntRunStatus
  startedAt DateTime              @default(now())
  endedAt   DateTime?

  maxActions  Int
  actionsUsed Int @default(0)

  homeCellId     String
  keyCellId      String
  treasureCellId String

  pathCellIds    Json // array of CellId strings
  keyIndexInPath Int

  revealedPathCellIds   Json // array of CellId strings
  currentCellId         String
  hasKey                Boolean @default(false)
  keyFoundAtAction      Int?
  treasureFoundAtAction Int?

  events TreasureHuntEvent[]

  @@index([playerId, worldId, runIndex])
}

// --- events ---

model TreasureHuntEvent {
  id        String                @id @default(auto()) @map("_id") @db.ObjectId
  runId     String                @db.ObjectId
  playerId  String                @db.ObjectId
  type      TreasureHuntEventType
  createdAt DateTime              @default(now())

  run    TreasureHuntRun @relation(fields: [runId], references: [id])
  player Player          @relation(fields: [playerId], references: [id])

  // polymorphic payload, matches Zod discriminated union
  payload Json

  @@index([runId, createdAt])
}
